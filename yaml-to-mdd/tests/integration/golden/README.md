# Golden Files for MDD Comparison Tests

## Purpose

These tests prove that YAML-to-MDD conversion produces functionally equivalent output to ODX-to-MDD conversion (via odxtools). This validates that the YAML format can replace ODX for diagnostic description.

## Test Philosophy

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  flxc1000.yaml  │────▶│   yaml-to-mdd   │────▶│  generated.mdd  │
│   (our input)   │     │   (converter)   │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
                                                    COMPARE
                                                         │
┌─────────────────┐     ┌─────────────────┐     ┌────────▼────────┐
│   ODX (hidden)  │────▶│    odxtools     │────▶│  FLXC1000.mdd   │
│                 │     │   (generate.py) │     │  (reference)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘

If both MDDs are functionally equivalent → YAML can replace ODX
```

## File Structure

```
golden/
├── FLXC1000.mdd       # Reference MDD from CDA (generated by odxtools)
├── FLXCNG1000.mdd     # Reference MDD from CDA (generated by odxtools)
├── flxc1000.yaml      # Our YAML input for FLXC1000
├── flxcng1000.yaml    # Our YAML input for FLXCNG1000
└── README.md          # This file
```

## Reference Files

| File            | Source                                          | Purpose                 |
| --------------- | ----------------------------------------------- | ----------------------- |
| FLXC1000.mdd    | `classic-diagnostic-adapter/testcontainer/odx/` | Reference (ODX-derived) |
| FLXCNG1000.mdd  | `classic-diagnostic-adapter/testcontainer/odx/` | Reference (ODX-derived) |
| flxc1000.yaml   | `examples/flxc1000/`                            | Test input              |
| flxcng1000.yaml | `examples/flxcng1000/`                          | Test input              |

## Test Flow

1. Load YAML file (e.g., `flxc1000.yaml`)
2. Convert to MDD using `yaml-to-mdd convert`
3. Parse generated MDD (protobuf container + flatbuffers payload)
4. Parse reference MDD (`FLXC1000.mdd`)
5. Compare structural properties:
   - ECU metadata (name, logical address)
   - Variants (names, identification patterns)
   - Sessions (IDs, names, transitions)
   - Security levels (levels, seed/key subfunctions)
   - DIDs (IDs, types, access permissions)
   - Services (SIDs, subfunctions)

## What We Compare

| Property         | Comparison Method                   |
| ---------------- | ----------------------------------- |
| ECU name         | Exact string match                  |
| Logical address  | Exact value match                   |
| Variant names    | Set equality (with ECU prefix)      |
| Variant patterns | Matching parameter comparison       |
| Session IDs      | Set equality                        |
| Session names    | String match per ID                 |
| Security levels  | Set equality (odd numbers: 3, 5, 7) |
| DID IDs          | Set equality                        |
| DID types        | Structural equivalence              |
| Service SIDs     | Set equality                        |
| Service names    | Full match (28 services FLXC1000)   |

## Variant Name Convention

Variant names in MDD use the format `{ECU_NAME}_{variant_key}`:
- Base variant: `FLXC1000` (ECU name only)
- Named variants: `FLXC1000_Boot_Variant`, `FLXC1000_App_0101`

This matches the ODX/MDD convention where each variant's `DiagLayer.shortName` includes the ECU prefix.

## What We DON'T Compare (May Differ)

- **Timestamps**: Generation timestamps will differ
- **Internal ordering**: Order of elements may vary if semantically equivalent
- **Compression method**: LZMA vs GZIP vs ZSTD produce different binary output
- **Exact binary match**: Due to above, exact byte comparison is not expected

## Running Tests

```bash
cd diagnostic_yaml_proposal/yaml-to-mdd

# Run all MDD comparison tests
poetry run pytest tests/integration/test_mdd_comparison.py -v

# Run with detailed output on failure
poetry run pytest tests/integration/test_mdd_comparison.py -v --tb=long

# Run specific test
poetry run pytest tests/integration/test_mdd_comparison.py::TestFLXC1000Comparison -v
```

## Updating Reference Files

If the reference MDD files in CDA change, update them:

```bash
# From the yaml-to-mdd directory
cp ../../opensovd-server/classic-diagnostic-adapter/testcontainer/odx/FLXC1000.mdd tests/integration/golden/
cp ../../opensovd-server/classic-diagnostic-adapter/testcontainer/odx/FLXCNG1000.mdd tests/integration/golden/
```

## Adding New Test Cases

1. Create YAML file in `examples/<ecu_name>/`
2. Obtain reference MDD file (from CDA or other source)
3. Copy both to `golden/`
4. Add test class to `test_mdd_comparison.py`

## Troubleshooting

### Test fails with "ECU name mismatch"

Check that the YAML `ecu.name` matches the ECU name in the reference MDD.

### Test fails with "DID missing"

Ensure all DIDs from the reference MDD are defined in the YAML file.

### Compression errors

Ensure the MDD reader supports all compression types used. Common types:
- 0: None (raw)
- 1: LZMA
- 2: GZIP
- 3: ZSTD
