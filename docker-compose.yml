# Docker Compose for running OpenSOVD Classic Diagnostic Adapter
#
# Usage:
#   1. Convert your YAML files to MDD first:
#      yaml-to-mdd convert yaml-schema/example-ecm.yml -o .output/example-ecm.mdd
#
#   2. Build and run:
#      docker compose up --build
#
# Or use the convenience script:
#   ./run-cda.sh yaml-schema/example-ecm.yml yaml-schema/minimal-ecu.yml

services:
  cda:
    build:
      context: https://github.com/eclipse-opensovd/classic-diagnostic-adapter.git#main
      dockerfile: testcontainer/cda/Dockerfile
    image: diagnostic-yaml/cda:local
    container_name: cda
    ports:
      - "${CDA_PORT:-20002}:${CDA_PORT:-20002}"
    volumes:
      - ./.output:/data:ro
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - CDA_PORT=${CDA_PORT:-20002}
    command:
      - "-d"
      - "/data"
      - "--listen-port"
      - "${CDA_PORT:-20002}"
      - "--listen-address"
      - "0.0.0.0"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CDA_PORT:-20002}/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
